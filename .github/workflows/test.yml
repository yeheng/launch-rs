name: æµ‹è¯•å’Œè´¨é‡æ£€æŸ¥

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  NODE_ENV: test

jobs:
  # å‰ç«¯æµ‹è¯•ä½œä¸š
  frontend-tests:
    name: å‰ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Bun ç¯å¢ƒ
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: å®‰è£…ä¾èµ–
      run: bun install
      
    - name: TypeScript ç±»å‹æ£€æŸ¥
      run: bunx vue-tsc --noEmit
      
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: bun run test:run
      
    - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡
      run: bun run test:coverage
      
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: frontend
        
  # åç«¯æµ‹è¯•ä½œä¸š
  backend-tests:
    name: Rust åç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Rust ç¯å¢ƒ
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        components: clippy
        override: true
        
    - name: Rust ä»£ç æ ¼å¼æ£€æŸ¥
      uses: actions-rs/cargo@v1
      with:
        command: fmt
        args: --check --manifest-path src-tauri/Cargo.toml
        
    - name: Rust Clippy æ£€æŸ¥
      uses: actions-rs/cargo@v1
      with:
        command: clippy
        args: --manifest-path src-tauri/Cargo.toml -- -D warnings
        
    - name: è¿è¡Œ Rust æµ‹è¯•
      uses: actions-rs/cargo@v1
      with:
        command: test
        args: --manifest-path src-tauri/Cargo.toml --verbose
        
    - name: å®‰è£… Tarpaulin (è¦†ç›–ç‡å·¥å…·)
      uses: actions-rs/cargo@v1
      with:
        command: install
        args: cargo-tarpaulin
        
    - name: ç”Ÿæˆ Rust è¦†ç›–ç‡
      uses: actions-rs/cargo@v1
      with:
        command: tarpaulin
        args: --manifest-path src-tauri/Cargo.toml --out xml --output-dir coverage
        
    - name: ä¸Šä¼  Rust è¦†ç›–ç‡
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/cobertura.xml
        flags: backend

  # E2E æµ‹è¯•ä½œä¸š
  e2e-tests:
    name: E2E æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Bun ç¯å¢ƒ
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: å®‰è£…ä¾èµ–
      run: bun install
      
    - name: è¿è¡Œ E2E æµ‹è¯•
      run: bun run test:e2e
      
    - name: ä¸Šä¼  E2E æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-test-results
        path: test-results/
        retention-days: 7

  # é›†æˆæ„å»ºæµ‹è¯•
  build-test:
    name: æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Bun ç¯å¢ƒ
      uses: oven-sh/setup-bun@v1
      
    - name: è®¾ç½® Rust ç¯å¢ƒ
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev librsvg2-dev
        
    - name: å®‰è£…ä¾èµ–
      run: bun install
      
    - name: æ„å»ºåº”ç”¨
      run: bun run build
      
    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: |
        test -d dist
        test -f dist/index.html
        
  # è´¨é‡é—¨æ§
  quality-gate:
    name: è´¨é‡é—¨æ§
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests, e2e-tests, build-test]
    if: always()
    
    steps:
    - name: æ£€æŸ¥æ‰€æœ‰ä½œä¸šçŠ¶æ€
      run: |
        echo "å‰ç«¯æµ‹è¯•: ${{ needs.frontend-tests.result }}"
        echo "åç«¯æµ‹è¯•: ${{ needs.backend-tests.result }}"
        echo "E2Eæµ‹è¯•: ${{ needs.e2e-tests.result }}"
        echo "æ„å»ºæµ‹è¯•: ${{ needs.build-test.result }}"
        
        if [[ "${{ needs.frontend-tests.result }}" != "success" ]] || \
           [[ "${{ needs.backend-tests.result }}" != "success" ]] || \
           [[ "${{ needs.e2e-tests.result }}" != "success" ]] || \
           [[ "${{ needs.build-test.result }}" != "success" ]]; then
          echo "âŒ è´¨é‡é—¨æ§å¤±è´¥ï¼šå­˜åœ¨æµ‹è¯•å¤±è´¥"
          exit 1
        fi
        
        echo "âœ… è´¨é‡é—¨æ§é€šè¿‡ï¼šæ‰€æœ‰æµ‹è¯•æˆåŠŸ"

  # æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
  performance-benchmark:
    name: æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®ç¯å¢ƒ
      uses: oven-sh/setup-bun@v1
      
    - name: å®‰è£…ä¾èµ–
      run: bun install
      
    - name: è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        echo "ğŸ” è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        bun run build
        
        # åˆ†ææ„å»ºå¤§å°
        echo "ğŸ“¦ æ„å»ºäº§ç‰©å¤§å°:"
        du -sh dist/
        
        # åˆ†æå…³é”®æ–‡ä»¶å¤§å°
        echo "ğŸ“„ å…³é”®æ–‡ä»¶å¤§å°:"
        ls -lh dist/assets/ | head -10
        
    - name: ä¿å­˜æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: performance-report.txt
        retention-days: 30